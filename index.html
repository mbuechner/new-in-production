<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Neu in Produktion</title>
  <!-- Bootstrap CSS -->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet">
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI=" rel="stylesheet">
  <style>
      .carousel-container {
          display: flex;
          gap: 10px;
          overflow-x: auto;
          padding: 10px 0;
      }

      .product-card {
          flex: 0 0 auto; /* Cards bleiben nebeneinander */
          width: 350px;
          margin: 0 10px;
      }

      .product-card img {
          width: 100%;
          height: auto;
      }

      .product-card .card-body {
          text-align: center;
      }

      .product-card .card-text {
          font-size: 0.9rem;
          word-wrap: break-word; /* Lange Wörter umbrechen */
          white-space: normal; /* Text wird normal umbrochen */
      }

      .fab {
          position: fixed;
          width: 60px;
          height: 60px;
          bottom: 30px; /* Abstand vom oberen Rand */
          right: 30px; /* Abstand vom rechten Rand */
          z-index: 1050; /* Über anderen Inhalten */
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Schatteneffekt */
          transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }

      .fab:hover {
          transform: scale(1.1); /* Vergrößert den Button leicht beim Hover */
          box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4); /* Schattenintensität erhöht sich */
      }

      /* Farbverlauf nur sichtbar, wenn die Klasse has-gradient hinzugefügt wird */
      .image-container.has-gradient::after {
          content: "";
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 100px; /* Höhe des Farbverlaufs */
          background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 1.0)); /* Farbverlauf */
          pointer-events: none; /* Sicherstellen, dass Klicks durchgehen */
      }</style>
</head>
<body>
<div class="container-fluid p-3 mb-5">
  <div class="position-fixed top-5 start-50 translate-middle-x" id="alert-container" style="z-index: 1056;"></div>
  <h1 class="text-center mb-3">„Neu in Produktion“</h1>
  <!-- Warenkorb Button -->
  <button class="btn btn-primary btn-lg rounded-circle fab" id="open-cart" type="button">
    <i class="bi bi-cart"></i>
  </button>
  <!-- Warenkorb Modal -->
  <div aria-hidden="true" aria-labelledby="cartModalLabel" class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cartModalLabel">Zusammenstellung</h5>
          <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group" id="cart-items">
            <!-- Dynamische Inhalte -->
          </ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="copy-ids">DDB-IDs kopieren</button>
          <button class="btn btn-danger" onclick="new bootstrap.Modal(document.getElementById('confirmModal')).show()">Alles löschen</button>
          <button class="btn btn-primary" data-bs-dismiss="modal" type="button">Schließen</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Bestätigungsmodal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Aktion bestätigen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Bist du sicher, dass du die Zusammenstellung löschen möchtest?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Nein</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="delete-ids">Ja</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Datumauswahl -->
  <div class="col-12 col-md-12 col-xl-6 mx-auto mb-5">
    <div class="input-group input-group">
      <span class="input-group-text col-12 col-md-auto">Zeitraum</span>
      <input class="form-control col-12 col-m" id="start-date" type="date">
      <input class="form-control col-12 col-m" id="end-date" type="date">
      <button class="btn btn-outline-primary col-12 col-md-auto" id="search-btn" type="button">Aktualisieren</button>
    </div>
  </div>
  <!-- Zeitraum-Anzeige -->
  <h2 class="text-center mb-3" id="date-range">&#160;</h2>
  <!-- Spinner während des Ladens -->
  <div class="d-flex justify-content-center d-none" id="loading-spinner">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Lade...</span>
    </div>
  </div>
  <!-- Container für Produktgruppen -->
  <div class="d-none" id="product-groups"></div>
</div>
<!-- Bootstrap JS und Abhängigkeiten -->
<script crossorigin="anonymous" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script crossorigin="anonymous" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script crossorigin="anonymous" integrity="sha256-bQqDH8GbS66FF5etM5MVfoYa+3hiRZwRImNZsn4sQzc=" src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script>
    // Funktionen für die Datumsverarbeitung ##############################################################################
    // Funktion, um das Standarddatum (letzte Woche) zu setzen
    function setDefaultDates() {
        const today = new Date();
        const lastWeek = new Date();
        lastWeek.setDate(today.getDate() - 7);

        document.getElementById('start-date').value = lastWeek.toISOString().split('T')[0];
        document.getElementById('end-date').value = today.toISOString().split('T')[0];
    }

    // Hilfsfunktion, um das Datum für Solr im passenden Format zu erzeugen
    function formatSolrDate(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}*`;
    }
    
    function htmlEncode(input) {
        // Helper-Funktion zum Encodieren eines einzelnen Strings
        const encodeString = (str) => str.replace(/&/g, '&amp;')
                                        .replace(/</g, '&lt;')
                                        .replace(/>/g, '&gt;')
                                        .replace(/"/g, '&quot;')
                                        .replace(/'/g, '&#39;');
    
        // Check, ob input null, undefined oder leer ist
        if (input === null || input === undefined || input === '') {
            return input; // Unverändertes Input zurückgeben
        }
    
        // Prüfen, ob das Input ein Array ist
        if (Array.isArray(input)) {
            return input.map(item => {
                // Check, ob item null, undefined oder leer ist
                if (item === null || item === undefined || item === '') {
                    return item; // Unverändertes Element zurückgeben
                }
                return encodeString(item); // Element encodieren
            });
        }
    
        // Wenn kein Array, normalen String encodieren
        return encodeString(input);
    }
    
    function getCcLicenseAbbreviation(uri) {
      const ccLicenses = {
        "creativecommons.org/licenses/by/4.0": "CC BY 4.0",
        "creativecommons.org/licenses/by-sa/4.0": "CC BY-SA 4.0",
        "creativecommons.org/licenses/by-nd/4.0": "CC BY-ND 4.0",
        "creativecommons.org/licenses/by-nc/4.0": "CC BY-NC 4.0",
        "creativecommons.org/licenses/by-nc-sa/4.0": "CC BY-NC-SA 4.0",
        "creativecommons.org/licenses/by-nc-nd/4.0": "CC BY-NC-ND 4.0",
        "creativecommons.org/publicdomain/zero/1.0": "CC0 1.0",
        "creativecommons.org/publicdomain/mark/1.0": "Public Domain Mark 1.0",
        "creativecommons.org/licenses/by/3.0": "CC BY 3.0",
        "creativecommons.org/licenses/by-sa/3.0": "CC BY-SA 3.0",
        "creativecommons.org/licenses/by-nd/3.0": "CC BY-ND 3.0",
        "creativecommons.org/licenses/by-nc/3.0": "CC BY-NC 3.0",
        "creativecommons.org/licenses/by-nc-sa/3.0": "CC BY-NC-SA 3.0",
        "creativecommons.org/licenses/by-nc-nd/3.0": "CC BY-NC-ND 3.0",
        "www.deutsche-digitale-bibliothek.de/lizenzen/nug-kkn": "Nicht urheberrechtlich geschützt – Keine kommerzielle Nachnutzung",
        "www.deutsche-digitale-bibliothek.de/lizenzen/vw": "Verwaistes Werk",
        "www.deutsche-digitale-bibliothek.de/lizenzen/unbekannt": "Rechtsstatus unbekannt",
        "www.deutsche-digitale-bibliothek.de/lizenzen/rv-ez": "Rechte vorbehalten – Zugang nach Autorisierung",
        "www.deutsche-digitale-bibliothek.de/lizenzen/rv-fz": "Rechte vorbehalten – Freier Zugang",
      };
    
      // Funktion zur Normalisierung und Umwandlung einer einzelnen URI
      function processSingleUri(singleUri) {
        if (typeof singleUri !== "string") {
          return singleUri; // Übergabewert im Fehlerfall zurückgeben
        }
    
        // Normalisiere die URI: Entferne http/https und ein abschließendes /
        let normalizedUri = singleUri.replace(/^https?:\/\//, "").replace(/\/$/, "");
    
        // Suche nach bekannten Lizenzen in der URI
        for (const license in ccLicenses) {
          if (normalizedUri.startsWith(license)) {
            return ccLicenses[license]; // Rückgabe des passenden Kürzels
          }
        }
    
        return singleUri; // Rückgabe der URI im Fehlerfall
      }
    
      if (uri === null || uri === undefined || uri === '') {
        return 'Keine Lizenz verfügbar';
      }
    
      // Wenn die URI ein Array ist, verarbeite jedes Element
      if (Array.isArray(uri)) {
        return uri.map(processSingleUri);
      }
    
      // Andernfalls verarbeite die URI als einzelnen Wert
      return processSingleUri(uri);
    }

    // ####################################################################################################################

    // Funktionen für die Thumbnails ######################################################################################
    // Funktion zum Extrahieren der Thumbnail-URL aus dem XML
    function getThumbnailUrl(previewStore) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(previewStore, 'text/xml');
            const nsResolver = (prefix) => {
                if (prefix === 'ns') {
                    return 'http://www.deutsche-digitale-bibliothek.de/cortex';
                }
                return null;
            };
            const thumbnailNode = xmlDoc.evaluate('//ns:thumbnail', xmlDoc, nsResolver, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
            const thumbnailHref = thumbnailNode.getAttribute('href');
            return `https://iiif.deutsche-digitale-bibliothek.de/image/2/${thumbnailHref}/full/350,/0/default.jpg`;
        } catch (error) {
            console.error('Fehler beim Parsen von preview_store:', error);
            // Platzhalterbild
            return 'https://via.placeholder.com/350';
        }
    }
    // ####################################################################################################################

    // Funktionen für die Gruppen #########################################################################################
    // Funktion zum Aktualisieren der Suche
    async function loadGroups(startDate, endDate) {
        const from = formatSolrDate(new Date(startDate));
        const to = formatSolrDate(new Date(endDate));

        // Suchzeitraum anzeigen
        const dateRangeElement = document.getElementById('date-range');
        dateRangeElement.textContent = `Suchzeitraum: ${startDate} bis ${endDate}`;
        const random = Math.floor(Math.random() * 10000);

        const apiUrl = `https://api.deutsche-digitale-bibliothek.de/2/search/index/search/select?q=last_update:[${from} TO ${to}] AND digitalisat:true&group=true&group.sort=random_${random} desc&group.field=provider_id&fl=id,title,dataset_id,license,preview_store&group.limit=100&rows=1000000`;

        try {
            const productGroups = document.getElementById('product-groups');
            // Vorherige Inhalte löschen
            productGroups.innerHTML = '';

            // Spinner anzeigen
            document.getElementById('loading-spinner').classList.remove('d-none');
            const response = await fetch(apiUrl);
            const data = await response.json();

            productGroups.classList.remove('d-none');

            // Spinner ausblenden
            document.getElementById('loading-spinner').classList.add('d-none');

            for (const group of data.grouped.provider_id.groups) {
                await renderGroup(group, productGroups);
                await updateGroupHeader(group.groupValue);
            }
        } catch (error) {
            console.error('Fehler beim Abrufen der Daten:', error);
            showAlert(`Daten konnten nicht geladen werden.`, 'danger');
        }
    }

    // Funktion zum Anzeigen einer Gruppe
    async function renderGroup(group, container) {
        const groupTitle = group.groupValue;
        const items = group.doclist.docs;

        const groupSection = document.createElement('div');
        groupSection.className = 'mt-5';

        const groupHeader = document.createElement('h3');
        groupHeader.textContent = groupTitle;
        groupHeader.id = `group-${groupTitle}`;
        groupHeader.className = 'group-header';

        const carouselContainer = document.createElement('div');
        carouselContainer.className = 'carousel-container border bg-light p-5';

        items.forEach((item) => {
            const card = document.createElement('div');
            card.className = 'card product-card';

            const imgWrapper = document.createElement('div');
            imgWrapper.style.cssText = 'max-height: 500px; overflow: hidden; position: relative;'
            imgWrapper.className = 'image-container';

            const img = document.createElement('img');
            img.className = 'card-img-top';
            img.src = getThumbnailUrl(item.preview_store);
            img.alt = item.title;
            img.style.cssText = 'object-fit: cover; object-position: top;';
            img.setAttribute('onerror', 'this.src=\'data:image/png;base64,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\';');
            img.setAttribute('loading', 'lazy');

            // Warten, bis das Bild vollständig geladen ist
            img.addEventListener('load', function () {
                // Überprüfen, ob das Bild höher ist als der Container
                if (img.height > imgWrapper.offsetHeight) {
                    imgWrapper.classList.add('has-gradient');
                }
            });

            imgWrapper.appendChild(img);

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body d-flex flex-column';

            const cardTitle = document.createElement('h5');
            cardTitle.className = 'card-title text-truncate';
            cardTitle.style.cssText = 'max-height: 150px;';
            cardTitle.innerHTML = `<a href="https://www.deutsche-digitale-bibliothek.de/item/${item.id}" target="_blank">${htmlEncode(item.title)}</a>`;
            cardTitle.setAttribute('data-bs-toggle', 'tooltip');
            cardTitle.setAttribute('data-bs-placement', 'top');
            cardTitle.setAttribute('title', item.title);
            new bootstrap.Tooltip(cardTitle);

            const cardText = document.createElement('p');
            cardText.className = 'card-text text-muted';
            cardText.innerHTML = `
              <dl class="row">
                <dt class="col-sm-4">Lizenz</dt>
                <dd class="col-sm-8">${getCcLicenseAbbreviation(item.license)} <small><a href="${item.license}" target="_blank"><i class="bi bi-arrow-up-right-square"></i></a></small></dd>
                <dt class="col-sm-4">Datenset</dt>
                <dd class="col-sm-8">${htmlEncode(item.dataset_id)} <small><a href="https://www.deutsche-digitale-bibliothek.de/searchresults?query=dataset_id%3A${htmlEncode(item.dataset_id)}" target="_blank"><i class="bi bi-arrow-up-right-square"></i></a></small></dd>
              </dl>
            `;

            const addButton = document.createElement('button');
            addButton.className = 'btn btn-success btn-sm mt-auto';
            addButton.textContent = 'Zur Zusammenstellung hinzufügen';
            addButton.addEventListener('click', () => {
                addToCart(groupTitle, item.id, img.src, item.title, item.license);
                addButton.classList.remove('btn-success');
                addButton.classList.add('btn-secondary');
                addButton.textContent = 'Zur Zusammenstellung hinzugefügt';
                addButton.disabled = true; // Button deaktivieren
            });

            cardBody.appendChild(cardTitle);
            cardBody.appendChild(cardText);
            cardBody.appendChild(addButton);
            card.appendChild(imgWrapper);
            card.appendChild(cardBody);
            carouselContainer.appendChild(card);
        });

        groupSection.appendChild(groupHeader);
        groupSection.appendChild(carouselContainer);
        container.appendChild(groupSection);
    }

    // Funktion zum Aktualisieren der Gruppenüberschrift
    async function updateGroupHeader(groupValue) {
        const apiUrl = `https://api.deutsche-digitale-bibliothek.de/2/search/index/organization/select?q=id:${groupValue} OR ddb_organization_id:${groupValue}&fl=id,preferredName`;

        try {
            const response = await fetch(apiUrl);
            const data = await response.json();

            if (data.response.docs.length > 0) {
                const organization = data.response.docs[0];
                const preferredName = organization.preferredName;
                const id = organization.id;
                const groupName = `<a href="https://www.deutsche-digitale-bibliothek.de/organization/${id}" target="_blank">${htmlEncode(preferredName)}</a>`;

                // Überschrift im DOM aktualisieren
                const header = document.getElementById(`group-${groupValue}`);
                if (header) {
                    header.innerHTML = groupName;
                }

                // Gruppennamen im Warenkorb aktualisieren
                cart.forEach((item) => {
                    if (item.group === groupValue) {
                        item.group = preferredName;
                    }
                });
                saveCart();
                // Änderungen speichern
            }
        } catch (error) {
            console.error(`Fehler beim Abrufen der Überschrift für Gruppe ${groupValue}:`, error);
        }
    }

    // ####################################################################################################################

    // Funktionen für den Warenkorb #######################################################################################
    // Warenkorb speichern
    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    // Warenkorb aktualisieren
    function updateCartModal() {

        const cartItems = document.getElementById('cart-items');
        cartItems.innerHTML = '';

        cart.forEach((item, index) => {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex align-items-center';
            listItem.dataset.index = index;
            listItem.setAttribute('role', 'button');

            listItem.innerHTML = `
                        <img src="${item.thumbnail}" alt="${htmlEncode(item.title)}" class="img-fluid" style="width: 80px; height: auto; margin-right: 10px;">
                        <div class="ms-2 me-2 flex-fill text-truncate">
                          <p class="fw-bold mb-1"><a href="https://www.deutsche-digitale-bibliothek.de/item/${item.id}" target="_blank">${htmlEncode(item.title)}</a></p>
                          <p class="mb-0">${htmlEncode(item.group)}</p>
                          <p class="text-muted mb-0"><small>${getCcLicenseAbbreviation(item.license)}</small></p>
                        </div>
                        <button class="btn btn-danger btn-sm delete-item"><i class="bi bi-trash"></i></button>
            `;

            cartItems.appendChild(listItem);
        });

        // Löschen-Buttons
        cartItems.querySelectorAll('.delete-item').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                cart.splice(index, 1);
                saveCart();
                updateCartModal();
            });
        });
    }

    // Produkt zum Warenkorb hinzufügen
    function addToCart(group, id, thumbnail, title, license) {
        const item = {
            group: document.querySelector('#group-' + group).textContent,
            id,
            thumbnail,
            title,
            license
        };
        cart.push(item);
        saveCart();
        showAlert(`${id} wurde zur Zusammenstellung hinzugefügt.`, 'success');
    }

    // ####################################################################################################################

    // Funktionen für Alerts ##############################################################################################
    function showAlert(message, type = 'success', timeout = 1500) {
        const alert = document.createElement('div')
        alert.classList.add('alert', `alert-${type}`, 'alert-dismissible', 'fade', 'show');
        alert.setAttribute('role', 'alert');
        alert.innerHTML = `<div class="text-break">${htmlEncode(message)}</div>`;

        const closeButton = document.createElement('button');
        closeButton.setAttribute('type', 'button');
        closeButton.setAttribute('data-bs-dismiss', 'alert');
        closeButton.setAttribute('aria-label', 'Close');
        closeButton.classList.add('btn-close');
        alert.append(closeButton);

        // Automatisches Entfernen nach Timeout
        setTimeout(() => {
            closeButton.click();
        }, timeout);

        document.getElementById('alert-container').append(alert);
    }

    // ####################################################################################################################

    let cart = null; // cart data
    document.addEventListener('DOMContentLoaded', function () {

        // Warenkorb initialisieren
        cart = JSON.parse(localStorage.getItem('cart')) || [];

        // Standardmäßig Daten der letzten Woche setzen
        setDefaultDates();

        // Drag & Drop aktivieren
        const cartItems = document.getElementById('cart-items');

        new Sortable(cartItems, {
            animation: 150,
            onUpdate: () => {
                cart = Array.from(cartItems.children).map((item) => {
                    const index = item.dataset.index;
                    return cart[index];
                });
                saveCart();
                updateCartModal();
            },
        });

        // Event-Listener
        // IDs kopieren
        document.getElementById('copy-ids').addEventListener('click', () => {
            const ids = cart.map((item) => item.id).join('\n');
            navigator.clipboard.writeText(ids).then(() => {
                showAlert(`DDB-IDs wurden in die Zwischenablage kopiert.`, 'success');
            });
        });

        // IDs löschen
        document.getElementById('delete-ids').addEventListener('click', () => {
            cart.splice(0, cart.length);
            saveCart();
            updateCartModal();
        });

        // Warenkorb öffnen
        document.getElementById('open-cart').addEventListener('click', () => {
            updateCartModal();
            // Warenkorb vor dem Anzeigen aktualisieren
            const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
            cartModal.show();
        });

        // Event-Listener für den Button
        document.getElementById('search-btn').addEventListener('click', () => {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (!startDate || !endDate) {
                showAlert(`Bitte Start- und Enddatum eingeben.`, 'warning');
                return;
            }
            loadGroups(startDate, endDate);
        });

        // erstes Laden der Seite
        document.getElementById('search-btn').click();
    });
</script>
</body>
</html>
